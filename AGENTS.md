# Repository Guidelines

## Monorepo & Structure

- Yarn 3 monorepo: only `example/` is in `workspaces`. `example-expo/` is an independent Bun + Expo project (not in Yarn).
- `src/`: TS sources (APIs, hooks, helpers). Nitro contract at `src/specs/RnIap.nitro.ts` — edit this, then regenerate.
- `nitrogen/generated/`: Auto-generated Nitro bridge (C++/platform glue). Commit but never edit manually.
- `ios/` (Swift) • `android/` (Kotlin + CMake): Native implementations. Names match `nitro.json` (`NitroIap`, namespace `iap`).
- `plugin/`: Expo config plugin (`withIAP`) + tests. `lib/`: bob build output. `docs/`: site + blog.
- Screens sync: edit `example/screens/*.tsx` (PascalCase) → auto-copied to `example-expo/app/*` (kebab-case). Do not edit copied files.

## Package Manager

- Uses Yarn 3 with workspaces. Only `example/` is in `workspaces`; `example-expo/` is independent (Bun + Expo).
- Install deps: `yarn install` (root + example). Expo demo: `cd example-expo && bun setup`.
- Add packages:
  - Library: `yarn add <pkg>`
  - Example: `yarn workspace rn-iap-example add <pkg>`
  - Example‑Expo: `cd example-expo && bun add <pkg>`
- Run scripts: `yarn <script>`; one‑off CLIs with `yarn dlx <pkg>` or `npx <pkg>`.

## Project Structure

```text
.
├─ src/
│  ├─ index.ts               # Public API exports
│  ├─ hooks/useIAP.ts        # React hook API
│  ├─ helpers/subscription.ts# Subscription helpers
│  ├─ utils/                 # error.ts, type-bridge.ts
│  ├─ specs/RnIap.nitro.ts   # Nitro interface (native contract)
│  └─ __tests__/             # Unit tests for src/*
├─ nitrogen/
│  └─ generated/
│     ├─ ios/ android/ shared/  # Autogenerated Nitro bridge code
│     └─ .gitattributes
├─ ios/
│  ├─ HybridRnIap.swift      # HybridObject implementation
│  ├─ ErrorUtils.swift       # Error mapping/JSON serialization
│  ├─ ProductStore.swift     # StoreKit 2 utilities
│  └─ Bridge.h               # Public header for RN
├─ android/
│  ├─ build.gradle           # Kotlin + Nitrogen autolinking
│  ├─ CMakeLists.txt         # C++ bridge build
│  └─ src/...                # Kotlin implementation
├─ plugin/
│  ├─ src/withIAP.ts         # Expo config plugin
│  └─ __tests__/             # Plugin tests
├─ example/                  # Yarn workspace RN app
│  ├─ screens/*.tsx          # Source screens (PascalCase)
│  └─ ios|android|...        # App project files
├─ example-expo/             # Independent Expo (Bun)
│  ├─ app/*.tsx              # Synced from example/screens (kebab-case)
│  └─ scripts/copy-screens.sh# Sync helper
├─ docs/
│  └─ blog/*.md              # Release notes, articles
├─ nitro.json                # Nitrogen configuration (module/name/auto-linking)
├─ NitroIap.podspec          # iOS podspec (adds Nitrogen files)
├─ package.json              # Scripts, workspaces, bob targets
└─ lib/                      # Built output (do not edit)
```

## Build, Test & Dev

- Install: `yarn install` (monorepo) • Expo demo: `cd example-expo && bun setup`
- Codegen: `yarn specs` (debug) or `yarn nitrogen` after any `*.nitro.ts` change
- Build pipeline: `yarn prepare` (Nitro version check → bob build → codegen → plugin build)
- Typecheck/Lint: `yarn typecheck` • `yarn lint` • fix ESLint `yarn lint:eslint` • format `yarn lint:prettier`
- Tests: library `yarn test` or `yarn test:ci` • plugin `yarn test:plugin` • example `yarn test:example`
- Run examples: `yarn workspace rn-iap-example ios|android|start` • Expo: `cd example-expo && bun ios|android|start`

## Coding Style & Conventions

- TypeScript strict, 2 spaces. ESLint extends `expo` + `prettier`; Prettier single quotes + trailing commas.
- Use `import type` for types; keep module exports typed. Nitro specs use clear, stable names for methods/types.
- Native class ordering (Swift/Kotlin): properties/init → cross‑platform public → platform‑specific public (…IOS/…Android) → event handlers → private helpers.

## Testing Guidelines

- Jest ignores `lib/`, `nitrogen/`, and `example/`. Match patterns in `jest.config.js` (src and plugin tests).
- Cover: helpers (`src/utils/*`), hooks (`src/hooks/*`), plugin behavior, error mapping. Avoid testing generated code.
- Use `yarn test:ci` for coverage; add focused tests near changes.

## Hook API Semantics (useIAP)

- Most hook methods return `Promise<void>` and update internal state. Read results from hook state: `products`, `subscriptions`, `availablePurchases`, etc.
- Value-returning exceptions in the hook:
  - `getActiveSubscriptions(ids?) => Promise<ActiveSubscription[]>` (also updates `activeSubscriptions`)
  - `hasActiveSubscriptions(ids?) => Promise<boolean>`
- The root API (from `src/index.ts`) is value-returning and can be awaited directly. Prefer root API when not using React state.

Example:

```ts
const { fetchProducts, products } = useIAP()
await fetchProducts({ skus: ['p1'] })
// then read products from state
```

## CI Checks

Run locally before pushing to avoid CI failures:

```bash
yarn install
yarn typecheck
yarn lint --fix
# If specs changed
yarn specs
# Run tests with coverage
yarn test:ci
# Or use helper script
yarn ci:check
```

## Platform-Specific Features

- iOS (StoreKit 2): Subscription management, promotional offers, family sharing, refund requests, transaction verification, receipt validation.
- Android (Play Billing): Multiple SKU purchases, subscription offers, obfuscated account/profile IDs, purchase acknowledgement, product consumption.
- Android billing uses automatic service reconnection; connection handling is simplified in native code.

## Error Handling

- Centralized TS helpers in `src/utils/*` and types in `src/types.ts`:
  - `parseErrorStringToJsonObj()` — parse native error strings into structured objects
  - `isUserCancelledError()` — detect user-cancelled operations
  - `ErrorCode` enum — normalized cross-platform error codes
- Native layers map platform errors to the same JSON shape before returning to JS.

Error JSON format (from native):

```json
{
  "code": "E_USER_CANCELLED",
  "message": "User cancelled the purchase",
  "responseCode": 1,
  "debugMessage": "User pressed cancel",
  "productId": "com.example.product"
}
```

Usage example:

```ts
try {
  await requestPurchase({
    /* ... */
  })
} catch (e) {
  const err = parseErrorStringToJsonObj(e)
  if (isUserCancelledError(err)) return
  console.error('IAP failed:', err.code, err.message)
}
```

## Troubleshooting

- Specs changed but build fails: run `yarn specs` to regenerate Nitrogen bridge and rebuild native.
- React duplication issues in example apps: ensure Metro alias resolves a single `react`/`react-native` (see `example/metro.config.js`).
- iOS pods: `cd example/ios && bundle install && bundle exec pod install` (for Expo example: `cd example-expo/ios && pod install`).
- Install issues: `yarn install`, clear cache `yarn cache clean`, or reinstall `rm -rf node_modules example/node_modules && yarn install`.
- Metro cache: `cd example && yarn start --reset-cache`.

## Nitro Modules

### Types

- Prefer primitives/strings → arrays/typed maps → optionals → tuples/variants → promises/callbacks (async/events) → dates/ArrayBuffer (binary) → hybrid objects (stateful).
- Arrays/Tuples: use `T[]` for lists, `[A, B]` for fixed shapes. Avoid sparse arrays.
- Optionals: model as `T | undefined`; prefer optional keys over `null` unions.
- Variants: discriminated unions, e.g. `{ kind: 'ok', value } | { kind: 'err', code }`.
- Maps: prefer typed shapes or `Map<string, T>`; avoid untyped index maps unless necessary.
- Binary: use `ArrayBuffer` (or typed arrays) for receipts/large payloads.

### Sync vs Async

- Sync: cheap getters/computed values only (no IO). Keep fast and side‑effect free.
- Async: network/StoreKit/Billing/FS/long tasks. Prefer `Promise`; stream/events via callbacks with unsubscribe.

### Errors

- Native returns JSON string: include `code`, `message`, `responseCode`, `debugMessage`, `productId`.
- Parse in JS via `parseErrorStringToJsonObj()`; use `isUserCancelledError()` where applicable.

### Performance

- Minimize bridge crossings; batch where sensible. Use `ArrayBuffer` for large binary.
- Favor custom structs/enums over untyped maps; cache results for sync getters.

### Nitrogen & Configuration

- Specs: `src/specs/*.nitro.ts` → run `yarn specs` after edits → rebuild native → commit `nitrogen/generated/`.
- `nitro.json`: keep module/name consistent with native (`NitroIap`, namespace `iap`), ensure autolinking keys match platform files.

### Library Usage

- Keep `react-native-nitro-modules` as a peer dependency; build via `yarn prepare` (bob + codegen + plugin build).
- Ship `nitrogen/` and TS types; exclude platform build artifacts. Template: https://github.com/mrousavy/nitro/tree/main/packages/template

### Spec Example

```ts
// src/specs/RnIap.nitro.ts
export type Purchase = { id: string; productId: string; date: Date }
export type Result<T> =
  | { kind: 'ok'; value: T }
  | { kind: 'err'; code: string; message: string }

export interface RnIapSpec {
  init(): Promise<void>
  fetchProducts(ids: string[]): Promise<Product[]>
  requestPurchase(
    id: string,
    opts?: { quantity?: number }
  ): Promise<Result<Purchase>>
  addPurchaseListener(cb: (p: Purchase) => void): void
  getStorefrontIOS?(): string
}
```

## Commits & Pull Requests

- Conventional commits: `feat:`, `fix:`, `docs:`, `refactor:`, `test:`, `ci:`, `chore:`. Example: `fix: handle StoreKit2 refund state`.
- PRs must include: what/why, linked issues, updated tests, RN + Expo verification steps, and no manual edits to `lib/` or `nitrogen/generated/`.
- Monorepo package adds: library `yarn add <pkg>` • example `yarn workspace rn-iap-example add <pkg>` • example-expo `cd example-expo && bun add <pkg>`.
